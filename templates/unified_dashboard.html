<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Honeypot Attack Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet.js (for world map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --accent: #00ff88;
            --text-color: #c9d1d9;
            --danger: #ff4b4b;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }

        header {
            background: linear-gradient(90deg, #00ff88, #00aaff);
            padding: 15px;
            text-align: center;
            font-size: 1.8em;
            color: #000;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: 0 0 15px #00ff88;
            animation: glow 2s ease-in-out infinite alternate;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 25px auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,255,136,0.2);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: scale(1.05);
        }

        .stat-title {
            font-size: 0.9em;
            text-transform: uppercase;
            opacity: 0.7;
        }

        .stat-value {
            font-size: 2em;
            color: var(--accent);
        }

        canvas {
            background: #0e131a;
            border-radius: 10px;
            padding: 10px;
        }

        h2 {
            margin-top: 40px;
            border-bottom: 2px solid var(--accent);
            display: inline-block;
            padding-bottom: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            text-align: center;
            padding: 12px;
            border-bottom: 1px solid #222;
        }

        th {
            background-color: #00ff8855;
            color: #fff;
        }

        tr:hover {
            background-color: #1f252e;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #555;
            margin-top: 40px;
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px var(--accent), 0 0 15px var(--accent); }
            to { text-shadow: 0 0 20px var(--accent), 0 0 30px var(--accent); }
        }

        /* Map styling */
        #attackMap {
            height: 500px;
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,255,136,0.2);
            margin-top: 20px;
        }

        .leaflet-popup-content-wrapper {
            background-color: #111;
            color: #00ff88;
            border: 1px solid #00ff88;
        }

        .leaflet-popup-tip {
            background-color: #00ff88;
        }
    </style>
</head>

<body>
    <header>üïµÔ∏è Honeypot Intrusion Monitoring Dashboard</header>

    <div class="container">

        <!-- Statistics Cards -->
        <div class="grid">
            <div class="card">
                <div class="stat-title">Total Attacks</div>
                <div class="stat-value">{{ statistics.total_attacks }}</div>
            </div>
            <div class="card">
                <div class="stat-title">Unique IPs</div>
                <div class="stat-value">{{ statistics.unique_ips }}</div>
            </div>
            <div class="card">
                <div class="stat-title">Top Service</div>
                <div class="stat-value">
                    {% if statistics.service_distribution %}
                        {% set sorted_services = statistics.service_distribution.items()|sort(attribute=1, reverse=true) %}
                        {{ sorted_services[0][0] if sorted_services else 'N/A' }}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Charts -->
        <h2>Attack Analytics</h2>
        <div class="grid">
            <div class="card"><canvas id="serviceChart"></canvas></div>
            <div class="card"><canvas id="attackTypeChart"></canvas></div>
            <div class="card"><canvas id="toolsChart"></canvas></div>
        </div>

        <!-- World Map Section -->
        <h2>Attack Source Map</h2>
        <div id="attackMap"></div>

        <!-- Recent Attacks -->
        <h2>Recent Attacks</h2>
        <table>
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>IP Address</th>
                    <th>Service</th>
                    <th>Attack Type</th>
                    <th>Username</th>
                    <th>Auth Method</th>
                </tr>
            </thead>
            <tbody>
                {% if attacks %}
                    {% for attack in attacks %}
                    <tr>
                        <td>{{ attack.timestamp }}</td>
                        <td>{{ attack.ip }}</td>
                        <td>{{ attack.service }}</td>
                        <td>{{ attack.attack_type }}</td>
                        <td>{{ attack.username }}</td>
                        <td>{{ attack.auth_method }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">No attacks recorded yet</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <footer>¬© 2025 Honeypot Security Dashboard ‚Äî AI Enhanced Visualization</footer>

    <!-- Chart.js Initialization -->
    <script>
        const serviceData = {{ statistics.service_distribution | tojson | safe }};
        const attackTypeData = {{ statistics.attack_types | tojson | safe }};
        const toolsData = {{ statistics.tools_detected | tojson | safe }};

        function createChart(ctxId, label, dataObj) {
            if (!dataObj || Object.keys(dataObj).length === 0) {
                document.getElementById(ctxId).getContext('2d').fillText('No data available', 10, 50);
                return;
            }
            
            new Chart(document.getElementById(ctxId), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataObj),
                    datasets: [{
                        data: Object.values(dataObj),
                        backgroundColor: ['#00ff88', '#00aaff', '#ffaa00', '#ff4b4b', '#8a2be2']
                    }]
                },
                options: {
                    plugins: {
                        title: { display: true, text: label, color: '#fff' },
                        legend: { labels: { color: '#ddd' } }
                    }
                }
            });
        }

        createChart('serviceChart', 'Service Distribution', serviceData);
        createChart('attackTypeChart', 'Attack Types', attackTypeData);
        createChart('toolsChart', 'Tools Detected', toolsData);
    </script>

    <!-- üåç Leaflet Map Script -->
    <script>
        const attacks = {{ attacks | tojson | safe }};
        const map = L.map('attackMap').setView([20, 0], 2);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 5,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Marker icon (using default marker since external icon may not load)
        const redIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background-color: #ff4b4b; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
            iconSize: [12, 12]
        });

        // Simple IP to approximate coordinates (for demo - in production use GeoIP)
        function ipToCoords(ip) {
            // Simple hash-based approximation for demo
            const parts = ip.split('.');
            if (parts.length === 4) {
                const lat = (parseInt(parts[0]) % 90) - 45;
                const lon = (parseInt(parts[1]) % 180) - 90;
                return [lat, lon];
            }
            return [20 + Math.random() * 40 - 20, Math.random() * 360 - 180];
        }

        // Loop through attacks and add markers
        if (attacks && attacks.length > 0) {
            attacks.forEach(a => {
                const coords = ipToCoords(a.ip);
                const popupContent = `
                    <b>IP:</b> ${a.ip}<br>
                    <b>Service:</b> ${a.service}<br>
                    <b>Type:</b> ${a.attack_type}<br>
                    <b>Time:</b> ${a.timestamp}
                `;
                L.marker(coords, { icon: redIcon })
                 .addTo(map)
                 .bindPopup(popupContent);
            });
        }
    </script>
</body>
</html>
